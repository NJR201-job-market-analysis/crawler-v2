# Cake çˆ¬èŸ²ç³»çµ±

ç¨‹å¼ç¢¼ä½æ–¼ https://github.com/NJR201-job-market-analysis/crawler/cake

ä¸€å€‹åŸºæ–¼ Celery å’Œ RabbitMQ çš„åˆ†å¸ƒå¼çˆ¬èŸ²ç³»çµ±ï¼Œç”¨æ–¼çˆ¬å– Cake å¹³å°çš„è·ç¼ºè³‡è¨Šã€‚

## ğŸ“ ç›®éŒ„çµæ§‹

```
/root/job-crawler/cake/
â”œâ”€â”€ setup.py                    # Python åŒ…é…ç½®
â”œâ”€â”€ Pipfile                     # Python ä¾è³´ç®¡ç†
â”œâ”€â”€ local.ini                   # ç’°å¢ƒé…ç½®æ–‡ä»¶
â”œâ”€â”€ genenv.py                   # ç’°å¢ƒè®Šæ•¸ç”Ÿæˆå™¨
â”œâ”€â”€ .env                        # ç’°å¢ƒè®Šæ•¸æ–‡ä»¶ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ crawler/                    # çˆ¬èŸ²æ¨¡çµ„ç›®éŒ„
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cake_config.py          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ cake_worker.py          # Celery Worker é…ç½®
â”‚   â”œâ”€â”€ cake_tasks.py           # Celery ä»»å‹™å®šç¾©
â”‚   â”œâ”€â”€ cake_producer.py        # ä»»å‹™ç”Ÿç”¢è€…
â”‚   â”œâ”€â”€ cake_crawler.py         # æ ¸å¿ƒçˆ¬èŸ²é‚è¼¯
â”‚   â””â”€â”€ main.py                 # ä¸»ç¨‹åºå…¥å£
â””â”€â”€ docker-compose.monitor.yml  # Docker ç›£æ§é…ç½®
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒæº–å‚™

```bash
# é€²å…¥é …ç›®ç›®éŒ„
cd /job-crawler/cake

# ç”Ÿæˆç’°å¢ƒè®Šæ•¸æ–‡ä»¶
ENV=DOCKER|DEV pipenv run python genenv.py

# å®‰è£ä¾è³´
pipenv install

# æ§‹å»º Docker æ˜ åƒæª”
docker build -f Dockerfile -t xxx/cake-crawler:0.0.0 .

# æ¨é€åˆ° Docker Hub
docker push xxx/cake-crawler:0.0.0

# å•Ÿå‹• RabbitMQã€MySQLã€Flowerã€PhpMyAdmin å®¹å™¨
docker compose -f docker-compose.monitor.yml up -d

# å•Ÿå‹• Cake çˆ¬èŸ² Worker
DOCKER_IMAGE_VERSION=0.0.0 docker compose -f docker-compose.app.yml up -d cake_worker_1

# æŸ¥çœ‹ Worker æ—¥èªŒï¼Œç¢ºå®šæ­£å¸¸å•Ÿå‹•
docker logs cake_worker_1

# å•Ÿå‹• Cake ä»»å‹™ç”Ÿç”¢è€…ï¼Œç¢ºå®šæœ‰åŸ·è¡Œç™¼é€ä»»å‹™
DOCKER_IMAGE_VERSION=0.0.0 docker compose -f docker-compose.app.yml up -d cake_producer

# æŸ¥çœ‹ä»»å‹™ç™¼é€ç‹€æ³
docker logs cake_producer

# å¦‚æœéƒ½æ­£å¸¸åŸ·è¡Œï¼Œç­‰ Worker è·‘å®Œå¯è¨ªå• localhost:8080 æŸ¥çœ‹è³‡æ–™æ˜¯å¦å¯«å…¥
```

### 2. é—œé–‰ Docker æœå‹™

```bash
# ä½¿ç”¨ Docker compose
docker compose -f docker-compose.monitor.yml down
docker compose -f docker-compose.app.yml down

# æŸ¥çœ‹å®¹å™¨ç‹€æ…‹
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### 3: åœ¨çµ‚ç«¯æ©Ÿå•Ÿå‹• Workerã€Producer

```bash
# çµ‚ç«¯ 1: å•Ÿå‹• Worker
pipenv run celery -A crawler.cake_worker worker --loglevel=info

# æŸ¥çœ‹ Worker ç‹€æ…‹
pipenv run celery -A crawler.cake_worker status
ps aux | grep celery

# çµ‚ç«¯ 3: åŸ·è¡Œ Producer
pipenv run python crawler.cake_producer

# æˆ–æ˜¯ç›´æ¥åŸ·è¡Œæ¸¬è©¦
pipenv run python crawler/main.py
```

### ç›£æ§ä»»å‹™åŸ·è¡Œ

- **Worker çµ‚ç«¯**: æŸ¥çœ‹ä»»å‹™åŸ·è¡Œæ—¥èªŒ docker logs cake_worker_1
- **Flower ç•Œé¢**: æŸ¥çœ‹ä»»å‹™ç‹€æ…‹å’Œçµ±è¨ˆ (http://localhost:5555)
- **RabbitMQ ç®¡ç†ç•Œé¢**: æŸ¥çœ‹éšŠåˆ—ç‹€æ…‹ (http://localhost:15672)
- **MySQL ç®¡ç†ç•Œé¢**: æŸ¥çœ‹è³‡æ–™åº«ç‹€æ…‹ (http://localhost:8080)

### ä»»å‹™é…ç½®

```python
# cake_producer.py
crawl_cake_jobs.delay(
    category="software-developer",    # è·ç¼ºé¡åˆ¥
    job_type="it_front-end-engineer", # è·ä½é¡å‹
    filename="cake_jobs.csv",         # è¼¸å‡ºæ–‡ä»¶å
)
```

## ç¨‹å¼ç¢¼æ¶æ§‹

- **`cake_config.py`**: ç’°å¢ƒè®Šæ•¸ç®¡ç†ï¼Œé€£æ¥ RabbitMQ å’Œ MySQL
- **`local.ini`**: å¤šç’°å¢ƒé…ç½®ï¼ˆDEV/DOCKER/PRODUCTIONï¼‰
- **`genenv.py`**: æ ¹æ“šç’°å¢ƒç”Ÿæˆ `.env` æ–‡ä»¶
- **`cake_worker.py`**: Celery æ‡‰ç”¨é…ç½®ï¼Œé€£æ¥ RabbitMQ
- **`cake_tasks.py`**: å®šç¾©çˆ¬èŸ²ä»»å‹™å’Œæ¸¬è©¦ä»»å‹™
- **`cake_producer.py`**: ä»»å‹™ç”Ÿç”¢è€…ï¼Œç™¼é€çˆ¬èŸ²ä»»å‹™ã€å°‡è³‡æ–™å¯«å…¥DB
- **`cake_crawler.py`**: æ ¸å¿ƒçˆ¬èŸ²é‚è¼¯ï¼Œè§£æ Cake ç¶²ç«™
